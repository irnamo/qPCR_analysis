---
title: "Untitled"
author: "Iris Mollhoff"
date: "2024-01-29"
output: html_document
---

# **Report** -- 2024.01.29
This r-markdown contains the code to reproducibly load qPCR data, process, perform statistical analysis, and generate figures. 
Raw data is sourced from the data directory. Functions are sourced from the 01_processing folder in the experiments directory.Final figures are saved ast .png files in the experiments directory.

## **Goals**
1. recalulate stats using key with replicate (rep) variable as 1-12 plants instead of 1-3 because 12 individual plants (6 wt and 6 ACET1) were used for this experiment.
1-3 was used as rep because effectively there were 3 biological rreplicates for WT+mock, WT+flg28, ACET1+mock, and ACET1+flg28

# **R Code**
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Clear global enviornment
```{r}
rm(list = ls())
```
##Load required packages
```{r}
library(pcr)
library(tidyverse)
library(ggpubr)
library(readxl)
library(scales)
library(ggtext)
library(multcomp)
library(lsmeans)
library(rcompanion)
library(viridis)
library(ggprism)
library(FSA)
library(gtools)
library(gginnards)
library(multcompView)
library(ggtext)
library(scales)
library(rstatix)
library(pastecs)
library(car)
```

## load data
```{r}
source("01_processing/loadfile_csv.R")

datafolder <- "E:/Files/PhD Files 2 Iris Mollhoff/Git stuff/qPCR_analysis_flgII28/data/"

rawcq_a <- loadfile_csv(datafolder,"20240125_a83_ACET1_actin-FLS3-WAK1")
rawcq_w <- loadfile_csv(datafolder,"20240122_a83_WT_actin-vin3-fls3-wak1")
                      
key <- loadfile_csv(datafolder,"20240130_a83_samplekey_12rep")#use different sample keay
```


## Process data
### clean data
```{r}
source("01_processing/cleandata1_384.R")
d_a <- cleandata1_384(rawcq_a, "Sample")
d_w  <- cleandata1_384(rawcq_w, "Sample")
```

### clean key
```{r}
source("01_processing/cleankey2.R")
k <- cleankey2(key,"sample")
```

###Combine data and key
```{r}
df_a <- right_join(k,d_a,by = c("Sample"))
df_w <- right_join(k,d_w,by = c("Sample"))
```

###Combine data from WT and ACET
```{r}
df <- bind_rows(df_a,df_w)
```

### calculate techrep
```{r}
source("01_processing/calctecrep1_384.R")

df1 <- calctecrep1_384(df)
```

### Pull actin (housekeeping gene)
```{r}
source("01_processing/pullhkg_384.R")

df_actin <- pullhkg_384(df1, "SlAct")
```

### calculate delta Ct and log delta ct--- for SlFLS3
```{r}
source("01_processing/deltact_384.R")

list_df2 <- deltact_384(df1,df_actin, "SlFLS3", c("Sample","genotype","treatment", "time", "rep"))
#returns list of tables (1)is delta cq or delta ct. (2) is the isolated marker gene

df1_marker <-list_df2[[2]] #the ct table for the marker of interest
df2_marker <-list_df2[[1]] #the delta-ct table
```

```{r}
#calculate average delta-Ct and 2^delta CT
df3_marker <- df2_marker %>% 
    dplyr::group_by(genotype,time,treatment) %>% 
    mutate(log_d_cq = 2^(-1*(d_cq)))
```
```{r}
df3_marker$genotype <- factor(df3_marker$genotype, levels=c("WT", "ACET1"))
```


## Data analysis
### Summary Statistics
```{r}
#source("02_analysis/anova2x.R")
#anova_treatment <- anova2x(df2)
```
```{r}
df3_marker %>%
  group_by(genotype, treatment, time) %>%
  get_summary_stats(d_cq, type = "mean_sd")
```
###Visualize data
```{r}
bxp <- ggboxplot(
  df3_marker, x = "time", y = "log_d_cq", 
  color = "genotype", palette = "jco",
  facet.by = "treatment", short.panel.labs = FALSE
  )
bxp
```
###check outliers
```{r}
df3_marker %>%
  group_by(genotype, treatment, time) %>%
  identify_outliers(log_d_cq)
```
**2024.01.09 result** - no outliers found in this dataset

###check normality assumption
```{r}
  #trim unused variables
  df4_marker<- df3_marker %>% 
    dplyr::select(!c(Target.x,marker_cq:hkg_cq)) %>% 
    ungroup() %>%
    relocate(Sample) %>% 
    na.omit()
```
```{r}
df4_marker %>%
  group_by(genotype, treatment, time) %>%
  shapiro_test(log_d_cq)
```
**2024.01.09 result** - samples that break normality assumption: WT-flg28-3h, ACET1-flg28-0h, ACET1-flg28-9h

###check qq-plot
```{r}
ggqqplot(df4_marker, "log_d_cq", ggtheme = theme_bw()) +
  facet_grid(genotype + treatment ~ time, labeller = "label_both")
```

###Run 3xANOVA test
```{r}
#test 3-way anova on  delta ct
res.aov <- anova_test(data = df4_marker, 
                        dv = d_cq, wid = rep,
                        within = c(genotype, treatment, time))
 res.aov
```
**RESULT 2024.01.230** produces error... in order to do repeat measures anova you need to have individuals that receive both the treatment and the control... otherwise the formula gets mad




